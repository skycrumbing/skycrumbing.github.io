---
layout: post
title: 分布式事务
tags:
- transaction
- MQ
categories: micro-services
description: 分布式事务
---
## 分布式事务
分布式系统涉及到了跨数据库操作，如果一个事务需要跨数据库，如何保证事务的ACID。

<!-- more -->

## 实现方式
### JTA（Java Transaction API）  
JAVA提供了JTA负责协调各个数据库的事务提交，可以保证强一致性。 为了实现分布式事务, JTA特设两个阶段  
阶段一：全局的事务管理器向各个数据库发出准备消息。 各个数据库需要在本地把一切都准备好，执行操作，锁住资源， 记录redo/undo 日志， 但是并不提交， 总而言之，要进入一个时刻准备提交或回滚的状态， 然后向全局事务管理器报告是否准备好了。  
阶段2： 如果所有的数据库都报告说准备好了， 那全局的事务管理器就下命令： 提交， 这时候各个数据库才真正提交 ， 由于之前已经万事具备，只欠东风，只需要快速完成本地提交即可。  
如果有任何一个数据库报告说没准备好， 事务管理器就下命令： 放弃， 这时候各个数据库要执行回滚操作， 并且释放各种在阶段1锁住的资源。  
弊端：JTA为了保证强一致性付出的代价太大，不利于高并发系统的运作。**分布式系统很多情况下只要保证最终一致性就行，不需要保证强一致性**，比如A给B转账，不必要求A的账户里少了一百，B的账户就立即多出一百，可以一段时间后再多出那一百。


## 消息队列  
![mq+定时器](\assets\img\distributedTransaction.jpg)
账户一和账号二分属两个不同的数据库，账户一给账户二转100  
1. 开启账户一的本地事务。扣除账户一100并且写入事件表中并把事件的状态置为new  
2. 定时程序定时读取状态为new的事件，将其写入消息队列中，写入成功则置为done否则不改变状态  
3. 账户二开启本地事务，读取MQ中toAccount为jane的事件，并判断本次增加操作是否已经执行过（防止定时程序多次写入相同事件）
4. 给账户二增加100


